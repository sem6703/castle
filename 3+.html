<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
</head>

<body>
	<strong>Строит зАмок по HTML-коду </strong>
	<input type="button" onclick="main()" value="Рисовать">
	<div id="allCountries" style="color: red"></div>

<textarea id="ta1" rows="20" cols="90" style="color: white; background: red;">
&lt;section&gt;&lt;a&gt;&lt;h2&gt;&lt;/h2&gt;&lt;/a&gt;&lt;ul&gt;
&lt;li&gt;&lt;div&gt;&lt;img&gt;&lt;p&gt;&lt;a&gt;&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;&lt;div&gt;&lt;img&gt;&lt;p&gt;&lt;a&gt;&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;&lt;div&gt;&lt;img&gt;&lt;p&gt;&lt;a&gt;&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;svg id="svg" width="715" height="215" viewBox="0 0 715 215" fill="none"&gt;
&lt;rect x="0" y="0" width="700" height="250" fill="silver" /&gt;

&lt;/svg&gt;

&lt;ul&gt;
&lt;li&gt;&lt;div&gt;&lt;img&gt;&lt;p&gt;&lt;a&gt;&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/li&gt;
&lt;li&gt;&lt;div&gt;&lt;img&gt;&lt;p&gt;&lt;a&gt;&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/li&gt;     
&lt;li&gt;&lt;div&gt;&lt;img&gt;&lt;p&gt;&lt;a&gt;&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/section&gt;


</textarea>
<br>
<textarea id="ta2" rows="4" cols="90" style="color: white; background: blue;">
</textarea>
<br>
<textarea id="ta3" rows="4" cols="50" style="color: white; background: black;font-size: 24px;">
</textarea>
<svg id="svg" width="715" height="215" viewBox="0 0 715 215" fill="none">
<rect x="0" y="0" width="700" height="250" fill="silver" />

</svg>

	<script>/*
	Рисует замок используя как входные данные html код
	*/
function main(){	
const svg=document.querySelector('#svg');
svg.innerHTML='<rect x="0" y="0" width="700" height="250" fill="silver" />';
	
	
const recta=(x1,y1,x2,y2,m,n)=>{
switch (m){
	case 'a': {svg.innerHTML+=`<rect x="${x1}" y="${y1}" width="${x2}" height="${y2}" fill="yellow" stroke="blue" />`;
	break}
	case '1': {
	svg.innerHTML+=
	`<polygon points="${x1} ${y1-dy} ${x1+(dx*0.4)|0} ${y1} ${x1+x2} ${y1} ${x1+x2} ${y1-dy}" fill="yellow" stroke="blue" />`;
	break}
	case '2': {
	svg.innerHTML+=
	`<polygon points="${x1-(dx*0.1)|0} ${y1-dy} ${x1} ${y1} ${x1+x2} ${y1} ${x1+x2} ${y1-dy}" fill="yellow" stroke="blue" />`;
	break}

}//switch
}


const trg0=(x1,y1)=>{
	svg.innerHTML+=`<polygon points="${x1} ${y1} ${x1+dx/2|0} ${y1+2*dy} ${x1+dx} ${y1}" fill="maroon" stroke="blue" />`;
	}
const trg3=(x1,y1)=>{
	svg.innerHTML+=`<polygon points="${x1} ${y1} ${x1+dx/2|0} ${y1+3*dy} ${x1+dx} ${y1}" fill="red" stroke="blue" />`;
	}
const rng=(x1,y1,x2)=>{
	svg.innerHTML+=`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y1}" stroke="teal" stroke-linecap="round" stroke-width="20"/>`;
	svg.innerHTML+=`<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y1}" stroke="yellow" stroke-linecap="round" stroke-width="18"/>`; 
	}
///////////////////////////////////////////////////////////////
function findMinus(x){
	const cre=x=>{
	let r = /-/ig;
	let t, a=[];
	while (t =r.exec(x))a.push(t.index); 
	return a  
	}  

	let e,xe,xd,n,i,s3,s4;//j,

	let a=cre(x);  //a: array of integer;
	for (let i=0; i<a.length; i++){//i
		n=a[i];
		e=''; d='';
		xe=0; xd=0;
	for (let j=1;j<=Math.min(a[i],x.length-a[i]); j++) {//j 
	n--;
	d=d+x[a[i]+j];
	e=x[a[i]-j]+e;
	switch(x[a[i]-j]){
	case 'z': {xe++; break}
	case 'a':
	case '1':
	case '2': {xe--; break}
	   }   
	switch(x[a[i]+j]){
	case 'a':
	case '1':
	case '2': {xd++; break}
	case 'z': {xd--; break}
	}

	if ((xe<0)||(xd<0)) break;	  
	if ((xe===xd)&&(xd===0)&&(e===d)) {	  
	s3=x.substring(0,n); //  от индекса a до индекса b 
	s4=x.substring(n); // от n до конца
	s4=s4.replace(/([^-]+)(-\1)+/gi,'($1)')
	return s3 + findMinus(s4);
	}
	}//j
	}//i
	return x;
	}//func findMinus	
	
	
let s=ta1.value;

s=s.replace(/\n/g,'_');
s=s.replace(/<!--.*-->?/g,'_');
let d='';
let b=false;
for (let i=0; i<s.length; i++){// теги переношу атрибуты нет
	switch (s[i]) {
		case '<':{d=d+'<'; b=!b; break}
		case '>':{d=d+'>'; b=false; break}
		case ' ':{if (b) b=false; break}
		default: {if (b) d=d+s[i]}
	}//switch
}
s=d;
['<br>','<meta>','<!doctype>',
'<sc'+'ript>','</sc'+'ript>',
'<style>','</style>',
'<title>','</title>',
'<head>','</head>',
'<html>','</html>',
'<i>','</i>','<b>','</b>'].forEach(x=>{
	let y=new RegExp(x,'g');
	s=s.replace(y,'_');
	});
s=s.replace(/\d/gi,' ');
s=s.replace(/(<svg>.+<\/svg>?)/gi,'<0>');

s=s.replace(/<ul>/gi,'<1>');
s=s.replace(/<li>/gi,'<2>');
s=s.replace(/<img>/gi,'<0>');
s=s.replace(/<input>/gi,'<0>');

d='';
for (let i=0; i<s.length; i++){// алфавит шестисимвольный
	switch (s[i]) {
		case '>':
		case '<':
		case '/':		
		case '0':
		case '1':		
		case '2':{d+=s[i]; break}		
	}//switch
}//for
s=d.replace(/<>/gi,'< >');// зазор вставил

s=s.replace(/< ><\/>/gi,'3');//скаты 
s=s.replace(/< >/gi,'a');//
s=s.replace(/<\/>/gi,'z');//
s=s.replace(/</gi,'');//
s=s.replace(/>/gi,'');//
s=s.replace(/za/gi,'z-a');//отступы меж башнями
s=s.replace(/z2/gi,'z-2');// 
s=s.replace(/z1/gi,'z-1');//
s=s.replace(/az/gi,'3');//

mc=s.match(/(2[^-\r\n]+)/gi);// разбираюсь с лишками
if (!!mc) mc.forEach(x=>{let y=new RegExp(x+'-'+x,'g');s=s.replace(y,x)});
ta2.value=s;

let ss=findMinus(s);// сокращенная формула
ta3.value=ss;

let stek1=[]; // квадраты и треуги
let stek2=[]; // кольца
let stek3=[]; // порядок рисования
const dx=50;
const dy=-23;
const u={'a':{x:0,y:dy,},'z':{x:0,y:-dy,},'0':{x:dx,y:0,},'1':{x:dx/2|0,y:dy,},'2':{x:0,y:dy,},'3':{x:dx,y:0,},'-':{x:dx,y:0,},'(':{x:0,y:0,},')':{x:0,y:0,},};
let x1=dx,y1=180;
let j=0;
for (let i=0; i<ss.length; i++){//alert(ss[i]);
let n=ss[i];
let ak='black';
switch (n){
case '(':{stek2.push({x:x1,y:y1});break}
case ')':{let v=stek2.pop();
	stek3.push({x1:v.x,y1:v.y,x2:x1,m:'(',s:y1+1,});
	break}
case 'a':{stek1.push({x:x1,y:y1,m:n,});ak='green';break}
case '1':{stek1.push({x:x1,y:y1,m:n,});ak='green';break}
case '2':{stek1.push({x:x1,y:y1,m:n,});ak='green';break}
case '0':{trg0(x1,y1);stek3.push({x1:x1,y1:y1,m:n,s:y1,}); break}
case '3':{trg3(x1,y1);stek3.push({x1:x1,y1:y1,m:n,s:y1,}); break}
case '-':{break}
case 'z':{let t=stek1.pop(); ak='red'; 
	recta(t.x,(t.y+dy),(x1-u[n].x)-t.x,-dy,t.m,j,);//
	stek3.push({x1:t.x,y1:(t.y+dy),x2:(x1-u[n].x)-t.x,y2:-dy,m:t.m,s:Math.max(t.y+dy,t.y),});
	j++;
	break} 
}//switch
x1+=u[n].x;
y1+=u[n].y;
};


stek3=stek3.sort((a,b)=>b.s-a.s); //сортировка точечная нотация

stek3.forEach(x=>{
switch (x.m){
case '(': {rng(x.x1,x.y1,x.x2,); break}
case '1':
case '2':
case 'a':{recta(x.x1,x.y1,x.x2,x.y2,x.m,1,);break}
case '0':{trg0(x.x1,x.y1,); break}
case '3':{trg3(x.x1,x.y1,); break}
}//switch
});
}//func main

main();

	</script>
</body>